<!--
  How to customize:
  1) Place your images in an images/ folder next to this HTML (1.jpg..8.jpg).
  2) Update headlines/messages in the frames array below.
  3) Tune colors in :root as needed.
-->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Mrs. Sandoval's Valentines View-Master</title>
    <style>
      :root {
        color-scheme: light;
        --bg-1: #fff0f3;
        --bg-2: #ffe4ec;
        --viewer-red: #e63950;
        --viewer-pink: #ff7aa2;
        --viewer-deep: #b2213c;
        --text-dark: #2c0f1b;
        --text-light: #fff7fa;
        --accent: #ff4d6d;
        --shadow: rgba(0, 0, 0, 0.18);
        --ring: rgba(255, 255, 255, 0.6);
        --radius: 22px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Trebuchet MS", "Verdana", "Arial Narrow", sans-serif;
        color: var(--text-dark);
        background:
          radial-gradient(circle at top, rgba(255, 255, 255, 0.8), transparent 55%),
          radial-gradient(circle at 15% 20%, rgba(255, 184, 207, 0.55), transparent 50%),
          linear-gradient(160deg, var(--bg-1), var(--bg-2));
        min-height: 100vh;
        padding: calc(env(safe-area-inset-top) + 16px)
          calc(env(safe-area-inset-right) + 16px)
          calc(env(safe-area-inset-bottom) + 16px)
          calc(env(safe-area-inset-left) + 16px);
        overscroll-behavior: none;
        -webkit-tap-highlight-color: transparent;
      }

      button,
      input,
      textarea {
        font: inherit;
      }

      .app {
        max-width: 980px;
        margin: 0 auto;
        display: grid;
        gap: 18px;
      }

      .app__header {
        text-align: center;
      }

      .app__header h1 {
        font-family: "Georgia", "Palatino Linotype", "Book Antiqua", serif;
        font-size: clamp(1.6rem, 5vw, 2.5rem);
        margin: 0 0 6px;
        letter-spacing: 0.5px;
      }

      .app__header p {
        margin: 0;
        font-size: clamp(0.95rem, 2.8vw, 1.1rem);
        opacity: 0.8;
      }

      .viewer {
        position: relative;
        background: linear-gradient(145deg, var(--viewer-red), var(--viewer-pink));
        border-radius: clamp(20px, 4vw, 40px);
        padding: clamp(16px, 4vw, 32px);
        box-shadow:
          0 24px 40px var(--shadow),
          inset 0 3px 8px rgba(255, 255, 255, 0.2),
          inset 0 -6px 12px rgba(0, 0, 0, 0.2);
        display: grid;
        gap: clamp(16px, 3vw, 26px);
      }

      .viewer__reel-area {
        display: grid;
        place-items: center;
        position: relative;
        touch-action: pan-y;
        user-select: none;
      }

      .reel {
        --frame-count: 8;
        --radius: 42%;
        width: min(78vw, 420px);
        aspect-ratio: 1 / 1;
        border-radius: 50%;
        position: relative;
        background:
          radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.6), transparent 45%),
          radial-gradient(circle at 70% 70%, rgba(0, 0, 0, 0.2), transparent 55%),
          linear-gradient(140deg, #fcd5ce, #f8edeb);
        box-shadow:
          inset 0 8px 16px rgba(255, 255, 255, 0.5),
          inset 0 -8px 18px rgba(0, 0, 0, 0.2),
          0 16px 24px rgba(0, 0, 0, 0.25);
        transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
      }

      .reel::before {
        content: "";
        position: absolute;
        inset: 9%;
        border-radius: 50%;
        background:
          radial-gradient(circle, rgba(255, 255, 255, 0.4), transparent 60%),
          radial-gradient(circle, rgba(0, 0, 0, 0.2), transparent 70%);
        opacity: 0.7;
      }

      .reel__frame {
        position: absolute;
        width: 18%;
        aspect-ratio: 1 / 1;
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform:
          translate(-50%, -50%)
          rotate(calc(360deg / var(--frame-count) * var(--i)))
          translateY(calc(-1 * var(--radius)));
        background: #fff;
        border: 3px solid rgba(255, 255, 255, 0.75);
        overflow: hidden;
        box-shadow:
          inset 0 0 0 2px rgba(0, 0, 0, 0.08),
          0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .reel__frame.is-active {
        outline: 3px solid var(--accent);
        outline-offset: 2px;
      }

      .reel__frame::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg, rgba(255, 255, 255, 0.6), transparent 60%);
        opacity: 0.4;
      }

      .reel__hub {
        position: absolute;
        inset: 36%;
        border-radius: 50%;
        background:
          radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.8), transparent 60%),
          radial-gradient(circle at 65% 65%, rgba(0, 0, 0, 0.25), transparent 70%),
          linear-gradient(160deg, #f7cad0, #e49ab0);
        box-shadow:
          inset 0 4px 6px rgba(255, 255, 255, 0.5),
          inset 0 -6px 10px rgba(0, 0, 0, 0.25);
      }

      .reel__screw {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #e0a3b5;
        box-shadow: inset 0 2px 3px rgba(255, 255, 255, 0.6);
      }

      .reel__screw.one { top: 24%; left: 47%; }
      .reel__screw.two { top: 45%; left: 24%; }
      .reel__screw.three { top: 45%; right: 24%; }

      .lever {
        position: absolute;
        right: clamp(-10px, -2vw, -4px);
        top: 50%;
        transform: translate(50%, -50%);
        min-width: 64px;
        min-height: 64px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(140deg, #fff, #ffd1dc);
        box-shadow:
          0 10px 20px rgba(0, 0, 0, 0.25),
          inset 0 3px 6px rgba(255, 255, 255, 0.8);
        color: var(--viewer-deep);
        font-weight: 700;
        letter-spacing: 0.5px;
      }

      .lever:active {
        transform: translate(50%, -50%) scale(0.96);
      }

      .viewer__window {
        position: relative;
        border-radius: clamp(14px, 3vw, 22px);
        background: #2a0d18;
        overflow: hidden;
        min-height: 220px;
        box-shadow:
          inset 0 10px 20px rgba(0, 0, 0, 0.4),
          0 10px 20px rgba(0, 0, 0, 0.25);
      }

      .viewer__window img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .viewer__window::after {
        content: "";
        position: absolute;
        inset: 0;
        background:
          linear-gradient(120deg, rgba(255, 255, 255, 0.45), transparent 60%),
          radial-gradient(circle at top right, rgba(255, 255, 255, 0.35), transparent 45%);
        pointer-events: none;
      }

      .loading-indicator {
        position: absolute;
        bottom: 10px;
        right: 12px;
        background: rgba(255, 255, 255, 0.9);
        color: #500c1f;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        display: none;
      }

      .loading-indicator.show {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .viewer__caption {
        background: rgba(255, 255, 255, 0.9);
        border-radius: var(--radius);
        padding: clamp(12px, 3vw, 18px);
        box-shadow: inset 0 3px 6px rgba(255, 255, 255, 0.7);
      }

      .viewer__caption h2 {
        margin: 4px 0;
        font-size: clamp(1.1rem, 3.3vw, 1.6rem);
      }

      .viewer__caption p {
        margin: 0;
        font-size: clamp(0.95rem, 2.6vw, 1.2rem);
        line-height: 1.35;
      }

      .progress {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #7a293f;
      }

      .viewer__controls,
      .viewer__extras {
        display: grid;
        gap: 10px;
      }

      .viewer__controls {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .viewer__controls button,
      .viewer__extras button,


      .spotify {
        background: rgba(255, 255, 255, 0.9);
        border-radius: var(--radius);
        padding: 12px;
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.16);
        display: grid;
        gap: 6px;
      }

      .spotify h2 {
        margin: 0;
        font-size: clamp(1rem, 3vw, 1.3rem);
      }

      .spotify p {
        margin: 0 0 6px;
        font-size: clamp(0.85rem, 2.4vw, 1rem);
        opacity: 0.8;
      }

      .spotify iframe {
        width: 100%;
        border: 0;
        border-radius: 12px;
        height: 152px;
      }

      .overlay {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        background: rgba(255, 237, 244, 0.92);
        border-radius: clamp(20px, 4vw, 40px);
        padding: 24px;
      }

      .overlay[hidden] {
        display: none;
      }

      .overlay__card {
        background: #fff;
        border-radius: 24px;
        padding: clamp(18px, 4vw, 28px);
        text-align: center;
        box-shadow: 0 16px 30px rgba(0, 0, 0, 0.2);
        max-width: 420px;
      }

      .overlay__card h2 {
        margin: 0 0 8px;
        font-size: clamp(1.3rem, 4vw, 1.8rem);
      }

      .overlay__card p {
        margin: 0 0 18px;
      }

      .overlay__card button {
        min-width: 120px;
      }

      .end-actions {
        display: grid;
        gap: 10px;
      }

      .end-actions button {
        min-height: 44px;
        border-radius: 999px;
        border: none;
        background: var(--viewer-red);
        color: var(--text-light);
        font-weight: 700;
        cursor: pointer;
      }

      .end-actions .ghost {
        background: #fff;
        color: #6b0f2c;
      }

      .no-wiggle {
        position: relative;
        --wiggle-x: 0px;
        --wiggle-y: 0px;
      }

      .no-wiggle.wiggle {
        animation: wiggle 0.35s ease;
      }

      @keyframes wiggle {
        0% { transform: translate(var(--wiggle-x), var(--wiggle-y)) rotate(0deg); }
        35% { transform: translate(calc(var(--wiggle-x) - 6px), var(--wiggle-y)) rotate(-6deg); }
        70% { transform: translate(calc(var(--wiggle-x) + 6px), var(--wiggle-y)) rotate(6deg); }
        100% { transform: translate(var(--wiggle-x), var(--wiggle-y)) rotate(0deg); }
      }

      .confetti {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 15;
      }

      .confetti-piece {
        position: absolute;
        width: 10px;
        height: 14px;
        border-radius: 2px;
        opacity: 0.9;
        animation: confetti-fall 2.2s ease-out forwards;
      }

      @keyframes confetti-fall {
        0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
        100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
      }

      .reel.click {
        animation: clicky 0.18s ease;
      }

      @keyframes clicky {
        0% { transform: scale(1); }
        50% { transform: scale(0.985); }
        100% { transform: scale(1); }
      }

      :focus-visible {
        outline: 3px solid var(--accent);
        outline-offset: 3px;
      }

      @media (min-width: 900px) {
        .viewer {
          grid-template-columns: repeat(2, minmax(0, 1fr));
          grid-template-areas:
            "reel window"
            "reel caption"
            "reel controls"
            "reel extras";
          align-items: center;
        }

        .viewer__reel-area { grid-area: reel; }
        .viewer__window { grid-area: window; min-height: 280px; }
        .viewer__caption { grid-area: caption; }
        .viewer__controls { grid-area: controls; }
        .viewer__extras { grid-area: extras; }
      }

      @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
          animation-duration: 0.001ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.001ms !important;
        }
      }
    </style>
  </head>
  <body>
    <main class="app">
      <header class="app__header">
        <h1>Valentine View-Master</h1>
        <p>Swipe, click the lever, or use arrow keys to advance.</p>
      </header>

      <section class="viewer" aria-label="View-Master viewer">
        <div class="viewer__reel-area" id="swipeArea">
          <div class="reel" id="reel">
            <div class="reel__hub">
              <span class="reel__screw one"></span>
              <span class="reel__screw two"></span>
              <span class="reel__screw three"></span>
            </div>
          </div>
          <button class="lever" id="leverBtn" aria-label="Next photo">Click!</button>
        </div>

        <div class="viewer__window" role="img" aria-label="Photo viewing window">
          <img id="mainImage" alt="" />
          <div class="loading-indicator" id="loadingIndicator" role="status" aria-live="polite">
            Loading...
          </div>
        </div>

        <div class="viewer__caption" aria-live="polite">
          <div class="progress" id="progress">0 / 0</div>
          <h2 id="captionHeadline">Insert the reel</h2>
          <p id="captionMessage">Tap "Insert reel" to begin the show.</p>
        </div>

        <div class="viewer__controls">
          <button id="prevBtn" aria-label="Previous photo">Back</button>
          <button id="nextBtn" aria-label="Next photo">Next</button>
        </div>

        <div class="viewer__extras">
          <label class="toggle" for="soundToggle">
            <input type="checkbox" id="soundToggle" />
            Sound
          </label>
          <label class="toggle" for="hapticToggle">
            <input type="checkbox" id="hapticToggle" />
            Haptic
          </label>
        </div>

        <div class="overlay" id="startOverlay">
          <div class="overlay__card">
            <h2>Insert reel</h2>
            <p>Tap to load the reel and start the Valentine story.</p>
            <button id="startBtn">Insert</button>
          </div>
        </div>

        <div class="overlay" id="endOverlay" hidden>
          <div class="overlay__card">
            <h2>Will you be my Valentine?</h2>
            <p id="finalMessage">I have one last question for you.</p>
            <div class="end-actions">
              <button id="yesBtn">Yes!</button>
              <button id="noBtn" class="ghost no-wiggle">No</button>
              <button id="backBtn" class="ghost">Back</button>
              <button id="replayBtn" class="ghost">Replay</button>
            </div>
          </div>
        </div>
      </section>

      <section class="spotify" aria-label="Background song">
        <h2>Background song</h2>
        <p>Tap play to start (Hopefully this is one of your favorite Banda Songs).</p>
        <!-- Note: Spotify embeds require a connection and user interaction to start playback. -->
        <iframe
          data-testid="embed-iframe"
          src="https://open.spotify.com/embed/track/3EjuEvxoNgHV6urIdPA4cl?utm_source=generator"
          width="100%"
          height="152"
          frameborder="0"
          allowfullscreen=""
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
          loading="lazy"
          title="Spotify player: track 3EjuEvxoNgHV6urIdPA4cl"
        ></iframe>
      </section>

    </main>

    <div class="confetti" id="confetti" aria-hidden="true"></div>

    <script>
      (() => {
        "use strict";

        const palette = [
          ["#ff6b6b", "#ffd6e0"],
          ["#ff8fab", "#ffe5ec"],
          ["#ffb3c1", "#ffe4e6"],
          ["#f7a8b8", "#ffd1dc"],
          ["#ff9aa2", "#ffdde1"],
          ["#ffb6b9", "#fae1dd"],
          ["#ffc3a0", "#ffd8be"],
          ["#ffcad4", "#fff0f3"],
          ["#fbc4ab", "#ffebd4"],
          ["#ffafcc", "#cdb4db"],
          ["#ffd1dc", "#c2f0fc"],
          ["#fcd5ce", "#f8edeb"],
        ];

        const makePlaceholder = (index, label, colors) => {
          const [c1, c2] = colors;
          const svg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="900" height="700">
              <defs>
                <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%" stop-color="${c1}"/>
                  <stop offset="100%" stop-color="${c2}"/>
                </linearGradient>
              </defs>
              <rect width="100%" height="100%" fill="url(#g)"/>
              <circle cx="170" cy="150" r="90" fill="rgba(255,255,255,0.4)"/>
              <circle cx="740" cy="540" r="120" fill="rgba(255,255,255,0.35)"/>
              <text x="50%" y="52%" font-family="Trebuchet MS, Verdana, sans-serif"
                    font-size="54" text-anchor="middle" fill="rgba(80, 12, 31, 0.8)">
                Replace me ${String(index).padStart(2, "0")}
              </text>
              <text x="50%" y="62%" font-family="Trebuchet MS, Verdana, sans-serif"
                    font-size="26" text-anchor="middle" fill="rgba(80, 12, 31, 0.7)">
                ${label}
              </text>
            </svg>`;
          return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
        };

        const frames = [
          {
            src: "images/1.jpg",
            alt: "Photo 1",
            headline: "Hi Mrs. Sandoval!",
            message: "Ready for a quick story?",
          },
          {
            src: "images/2.jpg",
            alt: "Photo 2",
            headline: "You know I've always had my head in the clouds,",
            message: "for as long as I can remember.",
          },
          {
            src: "images/3.jpg",
            alt: "Photo 3",
            headline: "However deeply chaotic life got,",
            message: "It was always worth daydreaming and looking up.",
          },
          {
            src: "images/4.jpg",
            alt: "Photo 4",
            headline: "A possibility of how things could be.",
            message: "Maybe even a house with a view and my own little family to match.",
          },
          {
            src: "images/5.jpg",
            alt: "Photo 5",
            headline: "The one thing I could really keep and call my own,",
            message: "Not just something I'd give away like I usually do.",
          },
          {
            src: "images/6.jpg",
            alt: "Photo 6",
            headline: "You know what surprised me the most?",
            message: "How quickly that changed and my new favorite dream was of you.",
          },
          {
            src: "images/7.jpg",
            alt: "Photo 7",
            headline: "I dont know what brought you my way, Mrs. Sandoval,",
            message: "But, I'm so glad I got to know you.",
          },
          {
            src: "images/8.jpg",
            alt: "Photo 8",
            headline: "I'll always be your loudest cheerleader whether you know it or not,",
            message: "One last click before a big question...",
          },
        ];


        const elements = {
          reel: document.getElementById("reel"),
          mainImage: document.getElementById("mainImage"),
          captionHeadline: document.getElementById("captionHeadline"),
          captionMessage: document.getElementById("captionMessage"),
          progress: document.getElementById("progress"),
          startOverlay: document.getElementById("startOverlay"),
          endOverlay: document.getElementById("endOverlay"),
          loadingIndicator: document.getElementById("loadingIndicator"),
          leverBtn: document.getElementById("leverBtn"),
          prevBtn: document.getElementById("prevBtn"),
          nextBtn: document.getElementById("nextBtn"),
          startBtn: document.getElementById("startBtn"),
          yesBtn: document.getElementById("yesBtn"),
          noBtn: document.getElementById("noBtn"),
          backBtn: document.getElementById("backBtn"),
          replayBtn: document.getElementById("replayBtn"),
          finalMessage: document.getElementById("finalMessage"),
          confetti: document.getElementById("confetti"),
          soundToggle: document.getElementById("soundToggle"),
          hapticToggle: document.getElementById("hapticToggle"),
          swipeArea: document.getElementById("swipeArea"),
        };

        const prefersReduced = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
        let currentIndex = -1;
        let audioContext;
        let frameEls = [];
        let objectUrls = [];


        const buildReel = () => {
          elements.reel.style.setProperty("--frame-count", frames.length);
          frameEls.forEach((el) => el.remove());
          frameEls = frames.map((frame, index) => {
            const item = document.createElement("div");
            item.className = "reel__frame";
            item.style.setProperty("--i", index);
            item.style.backgroundImage = `url('${frame.src}')`;
            item.style.backgroundSize = "cover";
            item.style.backgroundPosition = "center";
            elements.reel.appendChild(item);
            return item;
          });
        };

        const updateActiveFrame = () => {
          frameEls.forEach((frameEl, idx) => {
            frameEl.classList.toggle("is-active", idx === currentIndex);
          });
        };

        const updateCaption = () => {

          if (currentIndex >= frames.length) {
            elements.progress.textContent = `${frames.length} / ${frames.length}`;
            return;
          }
          const frame = frames[currentIndex];
          elements.captionHeadline.textContent = frame.headline;
          elements.captionMessage.textContent = frame.message;
          elements.progress.textContent = `${currentIndex + 1} / ${frames.length}`;
        };

        const updateImage = () => {
          if (currentIndex < 0 || currentIndex >= frames.length) return;
          const frame = frames[currentIndex];
          elements.mainImage.src = frame.src;
          elements.mainImage.alt = frame.alt;
        };

        const rotateReel = () => {
          const safeIndex = Math.min(Math.max(currentIndex, 0), frames.length - 1);
          const angle = -(360 / frames.length) * safeIndex;
          elements.reel.style.transform = `rotate(${angle}deg)`;
        };

        const showOverlay = (overlayEl, show) => {
          if (show) {
            overlayEl.removeAttribute("hidden");
          } else {
            overlayEl.setAttribute("hidden", "");
          }
        };

        const setIndex = (nextIndex) => {
          currentIndex = Math.max(-1, Math.min(nextIndex, frames.length));
          showOverlay(elements.startOverlay, currentIndex < 0);
          showOverlay(elements.endOverlay, currentIndex >= frames.length);
          rotateReel();
          updateActiveFrame();
          updateImage();
          updateCaption();
        };

        const clickAnimation = () => {
          elements.reel.classList.remove("click");
          void elements.reel.offsetWidth;
          elements.reel.classList.add("click");
        };

        const playClickSound = () => {
          if (!elements.soundToggle.checked) return;
          if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
          }
          if (audioContext.state === "suspended") {
            audioContext.resume();
          }
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          osc.type = "square";
          osc.frequency.value = 720;
          gain.gain.value = 0.12;
          osc.connect(gain);
          gain.connect(audioContext.destination);
          osc.start();
          gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.08);
          osc.stop(audioContext.currentTime + 0.08);
        };

        const triggerHaptic = () => {
          if (!elements.hapticToggle.checked) return;
          if (navigator.vibrate) {
            navigator.vibrate(18);
          }
        };

        const advance = (direction) => {
          const next = currentIndex + direction;
          setIndex(next);
          clickAnimation();
          playClickSound();
          triggerHaptic();
        };

        const toStart = () => setIndex(0);
        const toPrev = () => advance(-1);
        const toNext = () => advance(1);

        const handleKeys = (event) => {
          const tag = event.target.tagName;
          if (tag === "INPUT" || tag === "TEXTAREA") return;
          if (event.key === "ArrowRight") {
            event.preventDefault();
            toNext();
          }
          if (event.key === "ArrowLeft") {
            event.preventDefault();
            toPrev();
          }
        };


        const preloadImages = async () => {
          if (!elements.loadingIndicator) return;
          elements.loadingIndicator.classList.add("show");
          let loaded = 0;
          const total = frames.length;
          await Promise.all(
            frames.map((frame) => {
              return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                  loaded += 1;
                  elements.loadingIndicator.textContent = `Loading ${loaded} / ${total}`;
                  resolve();
                };
                img.onerror = () => {
                  loaded += 1;
                  elements.loadingIndicator.textContent = `Loading ${loaded} / ${total}`;
                  resolve();
                };
                img.src = frame.src;
              });
            })
          );
          elements.loadingIndicator.classList.remove("show");
        };






        const launchConfetti = () => {
          if (prefersReduced) return;
          const colors = ["#ff4d6d", "#ffd166", "#fca311", "#ffafcc", "#cdb4db"];
          const total = 36;
          elements.confetti.innerHTML = "";
          for (let i = 0; i < total; i += 1) {
            const piece = document.createElement("span");
            piece.className = "confetti-piece";
            piece.style.left = `${Math.random() * 100}%`;
            piece.style.background = colors[i % colors.length];
            piece.style.animationDelay = `${Math.random() * 0.4}s`;
            piece.style.transform = `translateY(-10vh) rotate(${Math.random() * 180}deg)`;
            elements.confetti.appendChild(piece);
          }
          setTimeout(() => {
            elements.confetti.innerHTML = "";
          }, 2400);
        };

        const wiggleNo = () => {
          const xShift = Math.round(Math.random() * 28 - 14);
          const yShift = Math.round(Math.random() * 18 - 9);
          elements.noBtn.style.setProperty("--wiggle-x", `${xShift}px`);
          elements.noBtn.style.setProperty("--wiggle-y", `${yShift}px`);
          elements.noBtn.classList.remove("wiggle");
          void elements.noBtn.offsetWidth;
          elements.noBtn.classList.add("wiggle");
        };

        const setupSwipe = () => {
          let startX = 0;
          let startY = 0;
          let isDown = false;

          const onDown = (event) => {
            isDown = true;
            startX = event.clientX;
            startY = event.clientY;
          };

          const onUp = (event) => {
            if (!isDown) return;
            isDown = false;
            const dx = event.clientX - startX;
            const dy = event.clientY - startY;
            if (Math.abs(dx) > 36 && Math.abs(dx) > Math.abs(dy)) {
              if (dx < 0) {
                toNext();
              } else {
                toPrev();
              }
            }
          };

          elements.swipeArea.addEventListener("pointerdown", onDown);
          elements.swipeArea.addEventListener("pointerup", onUp);
          elements.swipeArea.addEventListener("pointercancel", () => { isDown = false; });
        };

        const init = async () => {
          buildReel();
          updateCaption();
          await preloadImages();
          setIndex(-1);
        };

        elements.startBtn.addEventListener("click", () => {
          toStart();
        });
        elements.leverBtn.addEventListener("click", toNext);
        elements.nextBtn.addEventListener("click", toNext);
        elements.prevBtn.addEventListener("click", toPrev);
        elements.backBtn.addEventListener("click", () => setIndex(frames.length - 1));
        elements.replayBtn.addEventListener("click", () => setIndex(0));
        elements.yesBtn.addEventListener("click", () => {
          launchConfetti();
          elements.finalMessage.textContent = "Yay! You just made my day.";
        });
        elements.noBtn.addEventListener("click", wiggleNo);
        document.addEventListener("keydown", handleKeys);
        setupSwipe();
        init();
      })();
    </script>
  </body>
</html>
